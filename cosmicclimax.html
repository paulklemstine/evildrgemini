<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cosmic Climax Crusaders - Deluxe Mk III</title> <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400..900&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lucide-static@latest/font/Lucide.css">
    <style>
        /* --- Styles Updated for Retro-Futuristic Erotic Space Theme --- */
        body {
            font-family: 'Roboto', sans-serif;
            background: linear-gradient(135deg, #1a2a4f 0%, #2d3d6a 50%, #4a5b8a 100%);
            color: #e2e8f0;
            margin: 0;
            padding: 0;
            padding-bottom: 150px; /* Ensure space for footer */
        }

        /* Header Styling */
        .site-header { padding: 0; margin-bottom: 1rem; text-align: center; position: relative; overflow: hidden; }
        .header-banner-image { width: 100%; height: 120px; object-fit: cover; display: block; opacity: 0.7; filter: contrast(1.1) saturate(1.2); }
        .site-header h1 { font-family: 'Orbitron', sans-serif; font-size: 2.6rem; color: #f59e0b; text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.7); margin: 0; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 100%; padding: 0 1rem; box-sizing: border-box; background: rgba(15, 23, 42, 0.6); padding-top: 0.4rem; padding-bottom: 0.4rem; }

        /* Footer Styling */
        .site-footer {
            margin-top: 2rem; padding: 1.5rem 1rem; text-align: center; font-size: 0.875rem; color: #94a3b8; border-top: 1px solid #334155; background-color: rgba(15, 23, 42, 0.8); /* Slightly less transparent */
            position: fixed; /* Fixed footer */
            bottom: 0;
            left: 0;
            width: 100%;
            z-index: 10; /* Ensure footer is above body content */
        }
        .footer-buttons { display: flex; gap: 1rem; flex-wrap: wrap; justify-content: center; margin-bottom: 1rem; }
        #clipboardMessage { font-size: 0.8rem; color: #f43f5e; height: 1.2em; font-weight: 600; margin-bottom: 1rem; }

        /* Game Layout */
        #game-container { display: flex; flex-direction: column; max-width: 1200px; margin: 0 auto; padding: 0 1rem; gap: 1rem; }

        /* --- REMOVED: Persistent UI Area CSS --- */
        /* #persistent-ui-area { ... } */
        /* .persistent-card { ... } */
        /* etc. */

        /* Card Styling (Main Turn Content) */
        .space-card { background-color: rgba(30, 41, 59, 0.85) !important; color: #cbd5e1; border: 1px solid #475569; border-radius: 0.75rem; padding: 1.5rem; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3); margin-bottom: 1.5rem; }
        .space-card h2 { font-family: 'Orbitron', sans-serif; color: #67e8f9; border-bottom: 2px dashed #22d3ee; padding-bottom: 0.6rem; margin-bottom: 1.2rem; font-size: 1.6rem; font-weight: 700; text-align: center; flex-shrink: 0; }
        /* --- NEW: Headers for generated sections --- */
        .space-card h3 {
            font-family: 'Orbitron', sans-serif;
            color: #a3e635; /* Lime Green */
            border-bottom: 1px solid #65a30d; /* Darker Lime */
            padding-bottom: 0.4rem;
            margin-top: 1rem;
            margin-bottom: 0.8rem;
            font-size: 1.2rem; /* Slightly larger than persistent */
            font-weight: 600;
        }
        .space-card ul { list-style: none; padding: 0; margin: 0 0 1rem 0; }
        .space-card li { margin-bottom: 0.4rem; padding-left: 0.5rem; border-left: 3px solid #475569; }
        .space-card li strong { color: #f59e0b; }
        .space-card .status-item { display: flex; justify-content: space-between; align-items: center; gap: 0.5rem; margin-bottom: 0.4rem; padding: 0.2rem 0.4rem; background-color: rgba(15, 23, 42, 0.5); border-radius: 0.3rem;}
        .space-card .status-label { font-weight: 600; color: #67e8f9; } /* Cyan label */
        .space-card .status-value { text-align: right; font-weight: bold; }
        .space-card progress { height: 0.6rem; accent-color: #f472b6; width: 100%; margin-top: 0.1rem; background-color: #334155; border-radius: 3px;}


        .space-text { color: inherit; line-height: 1.7; word-wrap: break-word; font-size: 1rem; }
        .space-text strong { color: #f59e0b; font-weight: 700; } .space-text em { color: #a3e635; font-style: italic; }
        .space-text pre { background-color: #0f172a; padding: 0.8rem; border-radius: 0.5rem; overflow-x: auto; font-family: 'Courier New', Courier, monospace; font-size: 0.85rem; color: #93c5fd; margin-top: 0.5rem; border: 1px solid #1e293b; }

        /* Inputs */
        .space-input, .space-textarea { width: 100%; padding: 0.8rem; border: 1px solid #475569; border-radius: 0.5rem; color: #e2e8f0; background-color: #1e293b; font-family: 'Roboto', sans-serif; margin-bottom: 0.5rem; }
        .space-input::placeholder, .space-textarea::placeholder { color: #64748b; opacity: 0.7; }
        .space-input:focus, .space-textarea:focus { outline: none; border-color: #22d3ee; box-shadow: 0 0 0 3px rgba(34, 211, 238, 0.3); background-color: #0f172a; }
        .space-textarea { min-height: 70px; }

        /* Radio/Checkbox Options */
        .space-radio-option, .space-checkbox-option { display: flex; align-items: center; margin-bottom: 0.6rem; padding: 0.7rem 1rem; border-radius: 0.75rem; cursor: pointer; transition: background-color 0.2s, transform 0.1s; border: 1px solid #334155; color: inherit; background-color: rgba(15, 23, 42, 0.8); }
        .space-radio-option:hover, .space-checkbox-option:hover { background-color: #1e293b; border-color: #475569; }
        .space-radio-option input[type="radio"], .space-checkbox-option input[type="checkbox"] { margin-right: 0.8rem; cursor: pointer; accent-color: #f59e0b; width: 1.1rem; height: 1.1rem; flex-shrink: 0; }
        .space-radio-option label, .space-checkbox-option label { color: inherit; flex-grow: 1; cursor: pointer; font-weight: 600; }
        .space-radio-option label, .space-checkbox-option label { display: flex; align-items: center; width: 100%; }

        /* Sliders */
        .space-slider { width: 100%; cursor: pointer; accent-color: #f472b6; height: 0.6rem; background: #475569; border-radius: 9999px; appearance: none; -webkit-appearance: none; }
        .space-slider::-webkit-slider-thumb { appearance: none; -webkit-appearance: none; width: 1.3rem; height: 1.3rem; background: var(--slider-thumb-color, #f59e0b); border-radius: 50%; cursor: pointer; border: 2px solid #0f172a; box-shadow: 0 1px 3px rgba(0,0,0,0.4); }
        .space-slider::-moz-range-thumb { width: 1.3rem; height: 1.3rem; background: var(--slider-thumb-color, #f59e0b); border-radius: 50%; cursor: pointer; border: 2px solid #0f172a; box-shadow: 0 1px 3px rgba(0,0,0,0.4); }
        .space-slider-value-display { color: #f59e0b; font-weight: 700; min-width: 2rem; text-align: right; }

        /* Images */
        .space-image-container { margin-bottom: 1rem; text-align: center; }
        .space-image { max-width: 100%; height: auto; border-radius: 0.75rem; background-color: #1e293b; display: block; margin-left: auto; margin-right: auto; border: 2px solid #475569; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2); }
        .space-image-prompt { font-size: 0.8rem; color: #67e8f9; opacity: 0.9; font-style: italic; margin-top: 0.5rem; word-wrap: break-word; padding: 0 0.5rem; font-weight: 600; }
        .space-image-label { font-size: 0.9rem; font-weight: 700; color: #a3e635; margin-bottom: 0.3rem; }

        /* Buttons */
        .space-button {
            padding: 0.8rem 1.8rem; background: linear-gradient(to right, #f59e0b, #fbbf24); color: #1e293b; border: none; border-radius: 0.75rem; font-weight: 700; cursor: pointer; transition: all 0.2s ease; box-shadow: 0 2px 5px 0 rgba(0, 0, 0, 0.3); text-transform: uppercase; letter-spacing: 0.08em; white-space: nowrap; font-size: 0.9rem; font-family: 'Orbitron', sans-serif;
        }
        .space-button:hover { background: linear-gradient(to right, #d97706, #f59e0b); box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.4); transform: translateY(-2px) scale(1.03); }
        .space-button:active { transform: translateY(0) scale(1); box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.3); }
        .space-button:disabled { background: #475569; color: #94a3b8; cursor: not-allowed; opacity: 0.7; box-shadow: none; transform: none; }
        #modeToggleButton { background: linear-gradient(to right, #10b981, #22d3ee); } /* Emerald/Cyan */
        #modeToggleButton.red-alert-mode { background: linear-gradient(to right, #f43f5e, #ef4444); } /* Rose/Red */
        #resetGameButton { background: linear-gradient(to right, #ef4444, #dc2626); } /* Red */

        /* Loading/Error */
        .loading-indicator, .error-message { display: flex; justify-content: center; align-items: center; padding: 1rem; font-size: 1rem; border-radius: 0.75rem; margin-top: 1rem; font-weight: 600; }
        .loading-indicator { color: #67e8f9; background-color: #1e293b; border: 1px solid #475569; }
        .loading-indicator svg { width: 1.25rem; height: 1.25rem; color: #22d3ee; }
        .error-message { color: #fecdd3; background-color: #9f1239; border: 1px solid #fb7185; text-align: center; white-space: pre-wrap; }

        /* API Key Section */
        #apiKeySection { margin-bottom: 1rem; background: rgba(30, 41, 59, 0.6); padding: 1rem; border-radius: 0.75rem; border: 1px solid #475569; }
        #apiKeySection .api-key-label { color: #67e8f9; display: block; margin-bottom: 0.6rem; font-weight: 700; font-size: 1rem; font-family: 'Orbitron', sans-serif;}
        #apiKeySection .api-key-instructions span { color: #94a3b8; }
        #apiKeySection .api-key-instructions a { color: #f59e0b; text-decoration: underline; font-weight: 600; }
        #apiKeySection .api-key-instructions a:hover { color: #fbbf24; }

        /* Creative UI Elements (Adapted) */
        .space-toggle-switch { display: inline-flex; align-items: center; cursor: pointer; margin-top: 0.5rem; margin-bottom: 0.5rem; }
        .space-toggle-switch input { display: none; }
        .space-toggle-switch .switch-bg { width: 50px; height: 26px; background-color: #475569; border-radius: 13px; position: relative; transition: background-color 0.3s ease; border: 1px solid #64748b; flex-shrink: 0; }
        .space-toggle-switch .switch-handle { width: 22px; height: 22px; background-color: #cbd5e1; border-radius: 50%; position: absolute; top: 1px; left: 2px; transition: transform 0.3s ease; box-shadow: 0 1px 3px rgba(0,0,0,0.3); }
        .space-toggle-switch input:checked + .switch-bg { background-color: #10b981; /* Emerald */ }
        .space-toggle-switch input:checked + .switch-bg .switch-handle { transform: translateX(24px); }
        .space-toggle-switch span { margin-left: 0.5rem; font-weight: 600; color: #a3e635; /* Lime */ }

        .space-segmented-control { display: flex; border: 1px solid #475569; border-radius: 0.75rem; overflow: hidden; background-color: #1e293b; margin-top: 0.5rem; margin-bottom: 0.5rem; }
        .space-segmented-control label { flex: 1; text-align: center; padding: 0.5rem 0.8rem; cursor: pointer; transition: background-color 0.2s, color 0.2s; font-weight: 600; color: #94a3b8; font-size: 0.9rem; font-family: 'Orbitron', sans-serif; }
        .space-segmented-control input[type="radio"] { display: none; }
        .space-segmented-control input[type="radio"]:checked + label { background-color: #f59e0b; color: #0f172a; box-shadow: inset 0 1px 3px rgba(0,0,0,0.2); }
        .space-segmented-control label:not(:last-child) { border-right: 1px solid #475569; }

        /* Responsive layout for generated content */
        .turn-layout-grid {
            display: grid;
            grid-template-columns: 1fr; /* Default to single column */
            gap: 1.5rem;
        }
        @media (min-width: 768px) { /* Medium screens and up */
            .turn-layout-grid {
                grid-template-columns: 1fr 2fr; /* Sidebar-like layout */
            }
            /* Allow sidebar elements to stack if needed */
            .sidebar-content { display: flex; flex-direction: column; gap: 1.5rem; }
        }
        @media (min-width: 1024px) { /* Large screens and up */
            .turn-layout-grid {
                grid-template-columns: 1fr 3fr; /* Wider main content */
            }
        }
        .main-content-card { /* The card containing narrative, images, choices */
            display: flex; flex-direction: column; /* Ensure title is at top */
        }

    </style>
</head>
<body class="bg-slate-900 text-slate-300">

<header class="site-header">
    <img id="headerBanner" alt="Retro Sci-Fi Space Banner" class="header-banner-image">
    <h1>Cosmic Climax Crusaders</h1>
</header>

<div class="max-w-6xl mx-auto px-4 md:px-8">
    <div id="apiKeySection">
        <label for="apiKeyInput" class="api-key-label api-key-instructions">
            Enter Google AI API Key to Engage Warp Drive! 🚀
            <span class="block text-sm font-normal mt-1">
                (Get a key from Google AI Studio:
                <a href="https://aistudio.google.com/apikey" target="_blank" rel="noopener noreferrer">
                    aistudio.google.com/apikey
                </a>)
                <br>Or provide via URL: ?apiKey=YOUR_API_KEY
            </span>
        </label>
        <input type="password" id="apiKeyInput" class="space-input" placeholder="Paste your stardrive key here... ✨">
    </div>

    <div id="game-container">
        <div id="turn-content">
            <div id="initial-message" class="text-center text-cyan-400 p-4 font-semibold space-card">
                Feed the API Key into the console and hit "Engage!" to start your questionable voyage.
            </div>
        </div>

        <div id="loading" class="loading-indicator" style="display: none;">
            <svg class="animate-spin -ml-1 mr-3 h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none"
                 viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor"
                      d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <span id="loading-message">Calculating dubious trajectories... Please wait! 😵‍💫</span>
        </div>
        <div id="error-display" class="error-message" style="display: none;"></div>

        <div class="mt-6 text-center">
            <button id="submit-turn-button" class="space-button" disabled>
                Engage!
            </button>
        </div>
    </div>
</div>

<footer class="site-footer">
    <div class="footer-buttons">
        <button id="saveGameButton" class="space-button" disabled>Save Progress</button>
        <button id="modeToggleButton" class="space-button standard-mode">Mode: Standard Operations</button>
        <button id="resetGameButton" class="space-button" disabled>Abandon Ship</button>
    </div>
    <div id="clipboardMessage"></div> <div class="footer-content">
    <span>Delivering disappointment across the galaxy &copy; 3025</span>
</div>
</footer>

<script type="module">
    // --- Prompts (Updated: LLM Generates ALL UI for #turn-content) ---
    const spaceOperaPrompts = {
        redAlertRomanceAddendum: `**RED ALERT ROMANCE MODE OVERRIDE:**\n\n* **Core Concept:** OVERRIDE 'Standard Operations' Mode. Intensify focus on sensual encounters, suggestive situations, workplace tension/flirtation, and explicit (softcore-style) eroticism, all filtered through a comedic, retro-futuristic lens. Generate scenarios involving close encounters, revealing uniform malfunctions, seductive aliens/crewmates (referencing \`gameState.crew\` and \`gameState.profile.orientation\`), questionable 'diplomatic missions', exploring desires, navigating love triangles, or dealing with malfunctioning 'pleasure-bots'. Aim for high levels of titillation, humor, and slightly absurd sensuality.\n* **Player Profiling & Crew Interaction:** USE the player's profile (\`gameState.profile\`) and existing crew relationships (tracked in \`internalState\`) to tailor romantic/erotic encounters, character dialogue, and potential partners. Ensure encounters align with the player's stated interests AND the defined crew members. Allow choices that improve/damage relationships.\n* **Presentation Style (HTML - FULL TURN UI):** Generate richer, more suggestive HTML for the ENTIRE \`#turn-content\` area. Use warmer colors or dramatic reds/pinks via inline styles or Tailwind classes where appropriate for mood. Include CREATIVE displays for Status, Crew, and Inventory alongside the main event. Visuals (\`<img>\`) should depict suggestive poses, alluring aliens/robots/crewmates (based on \`gameState.crew\`), dimly lit environments, partial nudity (tasteful, pin-up style, within API limits), intense gazes, or comedic juxtapositions of sci-fi and sensuality. **Use the required URL format: \`https://image.pollinations.ai/prompt/{GENERATED_PROMPT}?width={WIDTH}&height={HEIGHT}&seed={RANDOM_SEED}&nologo=true&safe=false\`**. Generate relevant \`{GENERATED_PROMPT}\` text, choose appropriate \`{WIDTH}\` and \`{HEIGHT}\` (e.g., 368x448), and use a random \`{RANDOM_SEED}\`. Text uses more flirtatious, suggestive language.\n* **Encounters & Choices (HTML - Creative & Profile/Crew-Aware):** Generate encounters focused on romantic/sexual tension or explicit softcore situations, informed by the player's profile and potentially involving specific crew members. Choices are HTML form elements within \`<form id='space-opera-turn-form'>\`. VARY UI elements. Options involve expressing desire towards specific crew members, navigating risky romantic situations, or engaging in sensual activities. Choices significantly impact 'Heat' level, 'Morale', relationship status with crew (update in \`internalState\`), and potentially earn/spend 'Spice Credits'.\n* **Multi-Image Generation (HTML):** Generate 2-5 images per turn using standard \`<img>\` tags with the required Pollinations.ai URL format, reflecting the Red Alert theme and potentially depicting crew members in suggestive scenarios.\n* **Analyses (Internal):** 'internalState' logs relationship developments, choices involving crew, and player's romantic/sexual choices. 'gemini_facing_analysis' summarizes the player's 'type' and romantic strategy, potentially mentioning crew interactions. Player-facing analysis might offer cheeky advice about crew or the rising 'Heat' level.\n* **Status Impact:** Erotic events heavily influence 'Heat', 'Morale', and 'Relationship Status' with involved crew. 'Spice Credits' might be earned/spent. **NOTE:** Status display is generated BY YOU in the HTML. The AI should still generate status *changes* to be logged in \`internalState\`.\n`,

        firstrun: `**Instructions for Generating Turn 1 ONLY (Cosmic Climax Crusaders - Full HTML UI for #turn-content):**\n\n**(Input: None. Output: Raw HTML snippet for the ENTIRE Turn 1 UI inside \`#turn-content\`)**\n\n* **Goal:** Generate the initial HTML state for the \`#turn-content\` div. This includes introducing the premise, performing player profiling, AND displaying the initial Status, Crew (empty), and Inventory (empty).\n* **Theme:** Comedic Erotic Retro-Futuristic Space Opera. Start in 'Standard Operations' mode.\n* **Output Format:** Raw HTML content block for \`#turn-content\`.\n* **HTML Structure Requirements:**\n    * **Overall Layout:** Use a responsive layout (e.g., CSS Grid like \`.turn-layout-grid\`) to arrange the sections.\n    * **Use Tailwind & Custom Classes:** Employ \`.space-card\`, \`.space-button\`, \`.space-text\`, etc.\n    * **Sections to Generate:**\n        * **Status Display:** Generate HTML to display initial status values (e.g., Fuel: 80/100 ⛽, Morale: 50/100 😬, Clankiness: 30/100 🔩, Heat: 10/100 🔥, Spice Credits: 0 🌶️). Be CREATIVE with the presentation (e.g., use progress bars, icons, thematic text within a \`.space-card\` or similar container). Use \`<h3>🚀 Ship Status</h3>\` or similar.\n        * **Crew Roster:** Generate HTML to display the (initially empty) crew list. Use \`<h3>🧑‍🚀 Crew Roster</h3>\`. Indicate emptiness clearly (e.g., "No crew signed up yet!").\n        * **Inventory:** Generate HTML to display the (initially empty) inventory. Use \`<h3>🎒 Inventory</h3>\`. Indicate emptiness (e.g., "Pockets are depressurizingly empty.").\n        * **Main Event:** Generate the Title ("Awake in the Junk Bucket!") and description.\n        * **Images:** Generate 2-3 images using \`<img>\` tags. **CRITICAL: Use the Pollinations.ai URL format:** \`https://image.pollinations.ai/prompt/{GENERATED_PROMPT}?width={WIDTH}&height={HEIGHT}&seed={RANDOM_SEED}&nologo=true&safe=false\`. Generate relevant \`{GENERATED_PROMPT}\` text, choose appropriate \`{WIDTH}\` and \`{HEIGHT}\` (e.g., 368x448 or similar), and use a random \`{RANDOM_SEED}\`. Include a \`.space-image-prompt\` div below each image showing the \`{GENERATED_PROMPT}\` used.\n        * **Choices & Profiling:** Wrap choices in \`<form id=\"space-opera-turn-form\">\`. Include initial profiling questions (Species, Attraction, Motivation, Role) using VARIED UI elements (segmented controls, checkboxes, sliders, inputs).\n        * **Initial Action:** Include a simple starting action choice.\n    * **Hidden Fields:** CRITICAL - Include hidden inputs: \`<input type='hidden' name='turn' value='1'>\`, \`<input type='hidden' name='subjectId' value='Crewmate'>\`, \`<input type='hidden' name='internalState' value='{initial_escaped_markdown_state}'>\`.\n    * **No Submit Button:** DO NOT include \`#submit-turn-button\` in the generated HTML.\n* **Internal State (For Hidden Field):** Generate initial JSON-escaped Markdown. Include placeholders for profile, initial status, empty crew/inventory. Example structure:\n\`\`\`markdown\n# Captain's Log - Stardate ?? - Turn 1\n\n* **Subject:** Crewmate\n* **Mode:** Standard Operations\n* **Initial Status:** Fuel 80, Morale 50, Clankiness 30, Heat 10, SpiceCredits 0\n* **Player Profile:** { "species": "unspecified", "role": "unspecified", "orientation": "unspecified", "preferences": [], "motivation": "unspecified" }\n* **Crew Roster:** []\n* **Inventory:** []\n* **Current Situation:** Waking up on the rust bucket.\n* **Plan:** Initial profiling and orientation.\n\`\`\`\n* **Player/Gemini Analysis:** Optionally include these as text paragraphs within the generated HTML.\n\n* **Output Example Start (HTML for #turn-content):**\n\`\`\`html\n<div class=\"turn-layout-grid\">\n  <div class=\"sidebar-content\">\n    <div class=\"space-card\">\n      <h3>🚀 Ship Status Console</h3>\n      <ul>\n        <li class=\"status-item\"><span class=\"status-label\">Fuel ⛽:</span> <span class=\"status-value\">80/100</span></li>\n        <li><progress value='80' max='100'></progress></li>\n        <li class=\"status-item\"><span class=\"status-label\">Morale 😬:</span> <span class=\"status-value\">50/100</span></li>\n        <li><progress value='50' max='100'></progress></li>\n        <li class=\"status-item\"><span class=\"status-label\">Clankiness 🔩:</span> <span class=\"status-value\">30/100</span></li>\n        <li><progress value='30' max='100'></progress></li>\n        <li class=\"status-item\"><span class=\"status-label\">Heat Level 🔥:</span> <span class=\"status-value\">10/100</span></li>\n        <li><progress value='10' max='100'></progress></li>\n        <li class=\"status-item\"><span class=\"status-label\">Spice Credits 🌶️:</span> <span class=\"status-value\">0</span></li>\n      </ul>\n    </div>\n    <div class=\"space-card\">\n        <h3>🧑‍🚀 Crew Roster</h3>\n        <ul><li>Looks like it's just you for now...</li></ul>\n    </div>\n    <div class=\"space-card\">\n        <h3>🎒 Inventory</h3>\n        <ul><li>Your pockets contain only lint and existential dread.</li></ul>\n    </div>\n  </div>\n\n  <div class=\"main-content-card space-card\">\n    <h2>✨ Awake in the Junk Bucket! ✨</h2>\n    <p class=\"space-text\">The flickering emergency lights hum... Your head hurts. Where are you? Ah yes, the bridge of your 'slightly used' star freighter, the 'Cosmic Climax'. Time to figure out who you are and what you're doing here.</p>\n    <div class=\"space-image-container\">\n      <img src='https://image.pollinations.ai/prompt/grimy%20spaceship%20bridge%20flickering%20lights%20junk%20piled%20up%20retro%20futuristic%20style?width=368&height=448&seed=101&nologo=true&safe=false' alt='Ship Bridge View' class='space-image my-4'>\n      <div class='space-image-prompt'>grimy spaceship bridge flickering lights junk piled up retro futuristic style</div>\n    </div>\n    \n    <form id=\"space-opera-turn-form\">\n      <input type='hidden' name='turn' value='1'>\n      <input type='hidden' name='subjectId' value='Crewmate'>\n      <input type='hidden' name='internalState' value='{escaped initial state markdown}'>\n\n      <h3>--- Initial Scan Required ---</h3>\n      <p class='space-text mb-4'>Configure your bio-signature for the ship's questionable records.</p>\n      \n      \n      ...\n      \n      \n      ...\n    </form>\n    \n    ...\n  </div>\n</div>\n<script>\n // Optional inline script for sliders etc.\n<\/script>\n\`\`\`\n`,

        main: `**Cosmic Climax Crusaders LLM Turn Generation Protocol v4.0 - Full UI Generation**\n\n**(Input: Player Actions JSON, Previous Internal State Markdown (incl. Player Profile, Crew, Inventory sections), Current Mode (standard/red_alert), Current Client GameState (for display values: profile, status, crew, inventory). Output: Raw HTML snippet for the ENTIRE next turn UI in \`#turn-content\`.)**\n\n**Context:** Client manages a \`gameState\` object (profile, status numbers, crew array, inventory array) which is provided to you in the context message below. You use this data primarily for *displaying* the current state. Your primary memory is the \`internalState\` Markdown log (also provided). You generate the ENTIRE HTML UI for the \`#turn-content\` div each turn.\n\n**Core Goals:**\n1.  **Generate Full Turn UI (HTML):** Generate the COMPLETE HTML for \`#turn-content\`. This MUST include CREATIVE displays for the **current** Status, Crew Roster, and Inventory (based on the provided client \`gameState\` context) alongside the main event description, images, and choices. Use a responsive layout (e.g., CSS Grid \`.turn-layout-grid\`).\n2.  **Thematic Immersion (HTML):** Generate narrative, multiple visuals (\`<img>\`), choices (\`<form>\` elements) reflecting the theme (Futurama + Softcore). Adapt intensity based on mode. Reference player profile (\`gameState.profile\`), crew (\`gameState.crew\`), and inventory (\`gameState.inventory\`) context when relevant in the narrative and choices.\n3.  **Dynamic State & Logging (Internal State Markdown):** Based on player actions and event outcomes, calculate status changes (fuel, morale, clankiness, heat, spiceCredits) and relationship updates. **Log these changes thoroughly in the returned \`internalState\` Markdown.** Update crew roster or inventory sections *in the Markdown log* if characters/items are added/removed/used. Use the player profile to tailor events. **CRITICAL:** Ensure the updated, escaped Markdown is included in the hidden \`<input type='hidden' name='internalState' value='...'>\`.\n4.  **Creative & Engaging UI (HTML):** Generate varied HTML form elements for choices (\`radio\`, \`range\`, \`checkbox\`, \`textarea\`, \`toggle\`, \`segmented control\`) within \`<form id='space-opera-turn-form'>\`. Make the UI relevant to the action.\n\n**--- Protocol ---**\n\n1.  **Analyze Input:** Parse player actions JSON, receive previous \`internalState\` Markdown, current \`isRedAlertMode\`, and current client \`gameState\` (profile, status numbers, crew array, inventory array) from the context message.\n2.  **Update Internal Log & Plan:** Modify internal status/resources based on actions. Update relationships/narrative progress *within the internalState Markdown*. Update crew/inventory lists in Markdown if changed. Increment turn number. Plan the next event concept (reference profile, crew, inventory, mode). Log plans in \`internalState\`.\n3.  **Generate Next Turn HTML (for ALL of \`#turn-content\`):**\n    * **Overall Layout:** Use a responsive grid (\`.turn-layout-grid\`) or similar structure.\n    * **Status Display (Generated in HTML):** Create HTML for a \`.space-card\` (or similar) showing the **updated** status values (Fuel, Morale, etc.) based on your calculations from step 2. Use the values from the client \`gameState\` context as the *starting point* for this turn's calculations. Be CREATIVE in presentation (progress bars, icons, labels like \`<h3>✨ Vital Signs ✨</h3>\`).\n    * **Crew Roster Display (Generated in HTML):** Create HTML for a \`.space-card\` showing the **current** crew list based on the client \`gameState.crew\` context. List names, roles, maybe relationship hints. Be CREATIVE (\`<h3>👽 Ship Manifest 👽</h3>\`).\n    * **Inventory Display (Generated in HTML):** Create HTML for a \`.space-card\` showing the **current** inventory based on the client \`gameState.inventory\` context. List item names and descriptions. Be CREATIVE (\`<h3>📦 Cargo Hold Check 📦</h3>\`).\n    * **Main Event Card:** Create a \`.space-card\` for the narrative.\n        * **Event Description:** Title (\`<h2>\`) and narrative (\`<p class=\"space-text\">\`), tailored based on profile, crew, inventory, past actions, mode.\n        * **Images:** Embed 2-5 relevant images (\`<img>\`). **CRITICAL: Use the Pollinations.ai URL format:** \`https://image.pollinations.ai/prompt/{GENERATED_PROMPT}?width={WIDTH}&height={HEIGHT}&seed={RANDOM_SEED}&nologo=true&safe=false\`. Generate relevant \`{GENERATED_PROMPT}\`, choose dimensions (e.g., 368x448), use a random \`{RANDOM_SEED}\`. Include \`.space-image-prompt\` below each.\n        * **Choices Form:** Create \`<form id=\"space-opera-turn-form\">\` with VARIED & CREATIVE UI ELEMENTS. Include choices referencing crew, inventory items, or Spice Credits.\n        * **Hidden Fields:** CRITICAL - Include updated hidden fields: \`<input type='hidden' name='turn' value='{new_turn_number}'>\`, \`<input type='hidden' name='subjectId' value='{current_subject_id}'>\`, \`<input type='hidden' name='internalState' value='{UPDATED_escaped_markdown_state_incl_profile_crew_inventory}'>\`.\n    * **NO Submit Button:** Do NOT include \`#submit-turn-button\`.\n    * **Analysis Text:** Optionally include player-facing analysis.\n    * **Inline Scripts (Optional):** Include small \`<script>\` if needed for UI within the turn content.\n4.  **Escape & Compile Output:** Ensure valid HTML. Return the raw HTML snippet for \`#turn-content\`.\n\n**--- Input Example (Post-Profiling) ---**\n\`\`\`json\n{\n  \"actions\": {\n    \"turn\": 1,\n    \"subjectId\": \"Crewmate\",\n    \"profile_species\": \"robot\",\n    \"profile_attraction\": [\"robots\", \"aliens\"],\n    \"profile_motivation\": \"8\",\n    \"main_action\": \"find_coffee\"\n  },\n  \"internalState\": \"# Captain's Log - Stardate ?? - Turn 1\n...\n* Player Profile: { \"species\": \"robot\", \"role\": \"Crewmate\", ... }\n* Crew Roster: []\n* Inventory: []\n...\",\n  \"isRedAlertMode\": false,\n  \"clientGameState\": { // Provided by client for display reference\n     \"profile\": { \"species\": \"robot\", \"role\": \"Crewmate\", ... },\n     \"status\": { \"fuel\": 80, \"morale\": 50, \"clankiness\": 30, \"heat\": 10, \"spiceCredits\": 0 },\n     \"crew\": [],\n     \"inventory\": []\n  }\n}\n\`\`\`\n\n**--- Output Example (HTML for #turn-content - Turn 2 - Crew Encounter) ---**\n\`\`\`html\n<div class=\"turn-layout-grid\">\n  <div class=\"sidebar-content\">\n    \n    <div class=\"space-card\">\n      <h3>✨ Vital Signs Monitor ✨</h3>\n      <ul>\n        <li class=\"status-item\"><span class=\"status-label\">Fuel Tanks ⛽:</span> <span class=\"status-value\">78/100</span></li>\n        <li><progress value='78' max='100'></progress></li>\n        <li class=\"status-item\"><span class=\"status-label\">Crew Morale 😬:</span> <span class=\"status-value\">45/100</span></li>\n        <li><progress value='45' max='100'></progress></li>\n        <li class=\"status-item\"><span class=\"status-label\">Ship Clankiness 🔩:</span> <span class=\"status-value\">32/100</span></li>\n        <li><progress value='32' max='100'></progress></li>\n        <li class=\"status-item\"><span class=\"status-label\">Reactor Heat 🔥:</span> <span class=\"status-value\">15/100</span></li>\n        <li><progress value='15' max='100'></progress></li>\n        <li class=\"status-item\"><span class=\"status-label\">Spice Cache 🌶️:</span> <span class=\"status-value\">5</span></li>\n      </ul>\n      <p class='text-xs italic text-slate-400 mt-2'>Readouts nominal...ish.</p>\n    </div>\n    \n    <div class=\"space-card\">\n        <h3>👽 Ship Manifest 👽</h3>\n        <ul>\n            <li><strong>Zorp (Glorbon)</strong> - Engineer (Relationship: Neutral)</li>\n            \n        </ul>\n    </div>\n    \n    <div class=\"space-card\">\n        <h3>📦 Cargo Hold Check 📦</h3>\n        <ul>\n             <li>Fuzzy Dice (Slightly radioactive)</li>\n             \n        </ul>\n    </div>\n  </div>\n\n  \n  <div class=\"main-content-card space-card\">\n    <h2>✨ The 'Galley' Encounter ✨</h2>\n    <p class=\"space-text\">You shuffle towards the galley... Standing near the sputtering coffee machine is Zorp, the ship's perpetually optimistic (and slightly slimy) Glorbon engineer. He waves a tentacle enthusiastically.</p>\n    <div class=\"space-image-container\">\n        <img src='https://image.pollinations.ai/prompt/slimy%20green%20tentacled%20alien%20engineer%20Zorp%20waving%20optimistically%20next%20to%20broken%20coffee%20machine%20retro%20futuristic%20spaceship%20galley?width=368&height=448&seed=202&nologo=true&safe=false' alt='Zorp the Glorbon Engineer' class='space-image my-4'>\n        <div class='space-image-prompt'>slimy green tentacled alien engineer Zorp waving optimistically next to broken coffee machine retro futuristic spaceship galley</div>\n    </div>\n\n    <form id=\"space-opera-turn-form\">\n      <input type='hidden' name='turn' value='2'>\n      <input type='hidden' name='subjectId' value='Zorp'>\n      <input type='hidden' name='internalState' value='{updated state markdown, adding Zorp to crew list, updating status}'>\n\n      <fieldset class=\"mt-4 border-t pt-4 border-slate-600\">\n        <legend class=\"font-semibold text-cyan-400 mb-2\">Zorp gurgles: \"Greetings, friend-unit! Need assistance with the nutrient dispenser, or perhaps... something else?\"</legend>\n        \n        \n        ...\n      </fieldset>\n    </form>\n\n    <p class=\"mt-4 text-sm italic text-slate-400\">Zorp seems friendly, but watch your wallet. And maybe avoid shaking tentacles. Calculated Morale Drop: -5</p>\n  </div>\n</div>\n<script>\n // Optional inline script\n<\/script>\n\`\`\`\n\n**--- Key Principles ---**\n* **Full HTML UI:** Generate the ENTIRE HTML UI for the \`#turn-content\` div, including Status, Crew, Inventory displays using the provided client state for reference.\n* **Client Renders:** Client JS simply injects your HTML into \`#turn-content\`.\n* **Log in Markdown:** AI MUST update the \`internalState\` Markdown log thoroughly (status changes, profile, crew, inventory) and return it in the hidden field.\n* **Creative & Varied UI:** Mix up form elements. Make the Status/Crew/Inventory displays visually interesting and thematic.\n* **Visuals via \`<img>\`:** Embed images relevant to the scene/crew/items using the specified **Pollinations.ai URL format**.\n`,
        exampleTurn: `{...}` // Kept for structure, but content not used directly
    };

    // --- NEW Game State Object ---
    let gameState = {
        apiKey: null,
        encodedApiKey: null, // Store encoded version for saving
        turn: 0,
        mode: 'standard', // 'standard' or 'red_alert'
        profile: {
            species: "unspecified",
            role: "unspecified",
            orientation: "unspecified",
            preferences: [],
            motivation: "unspecified"
        },
        // Status values are the *logical* state used for calculations and sent to AI
        status: {
            fuel: 80,
            morale: 50,
            clankiness: 30,
            heat: 10,
            spiceCredits: 0
        },
        // Crew/Inventory arrays are the *logical* state sent to AI
        crew: [], // Array of crew member objects {name: 'Zorp', role: 'Engineer', relationship: 0}
        inventory: [], // Array of item objects {name: 'Fuzzy Dice', description: 'Slightly radioactive'}
        currentSubjectId: "Crewmate",
        currentInternalStateMarkdown: "", // The AI's running log
        currentModelIndex: 0,
        isLoading: false,
        isLocked: false // Replaces apiKeyLocked
    };

    // --- Model Switching State ---
    const AVAILABLE_MODELS = ["gemini-2.5-pro-exp-03-25", "gemini-1.5-pro", "gemini-2.0-pro-exp-02-05", "gemini-2.0-flash-exp", "gemini-exp-1206"];

    // --- Configuration ---
    const LOCAL_STORAGE_KEY = 'cosmicClimaxCrusadersState_v3_stateObject'; // Increment version key

    // --- DOM Element References ---
    const turnContentContainer = document.getElementById('turn-content');
    const loadingIndicator = document.getElementById('loading');
    const loadingMessage = document.getElementById('loading-message'); // Span for text
    const submitButton = document.getElementById('submit-turn-button');
    const apiKeyInput = document.getElementById('apiKeyInput');
    const apiKeySection = document.getElementById('apiKeySection');
    const errorDisplay = document.getElementById('error-display');
    const saveGameButton = document.getElementById('saveGameButton');
    const modeToggleButton = document.getElementById('modeToggleButton');
    const resetGameButton = document.getElementById('resetGameButton');
    const clipboardMessage = document.getElementById('clipboardMessage');
    const headerBanner = document.getElementById('headerBanner');
    const gameContainer = document.getElementById('game-container');
    // REMOVED: persistentUiArea, persistentStatusContainer, crewRosterContainer, inventoryContainer


    // --- Web Audio API Context ---
    let audioCtx = null;

    // --- Helper Functions ---
    function encodeApiKey(key) { try { return btoa(key); } catch (e) { console.error("Error encoding API key:", e); return ""; } }
    function decodeApiKey(encodedKey) { try { return atob(encodedKey); } catch (e) { console.error("Error decoding API key:", e); return null; } }

    // --- REMOVED: Persistent UI Rendering Functions ---
    // function renderPersistentStatus() { ... }
    // function renderCrewRoster() { ... }
    // function renderInventory() { ... }
    // function renderAllPersistentUI() { ... }


    // --- Modified Prompt Construction ---
    function constructPrompt(playerActionsJson) {
        const baseMainPrompt = spaceOperaPrompts.main;
        const activeAddendum = gameState.mode === 'red_alert' ? `\n\n---\n${spaceOperaPrompts.redAlertRomanceAddendum}\n---\n` : "";

        if (gameState.turn === 0) { // First run
            console.log("Constructing prompt for Turn 1 (Requesting FULL HTML UI for #turn-content + initial state)");
            const s = `${spaceOperaPrompts.firstrun}\n\n---\nClient Context: AI generates the ENTIRE HTML UI for #turn-content, including Status, Crew, Inventory, Event, Images, and Choices. Client simply renders this HTML.\n---\n\n--- Generate RAW HTML UI for Turn 1 (#turn-content) ---`;
            return s;
        } else { // Subsequent Turns
            console.log(`Constructing prompt for Turn ${gameState.turn + 1}`);
            // Clone relevant parts of gameState to pass for display context
            const clientStateContext = {
                profile: { ...gameState.profile },
                status: { ...gameState.status },
                crew: JSON.parse(JSON.stringify(gameState.crew)), // Deep clone arrays/objects
                inventory: JSON.parse(JSON.stringify(gameState.inventory))
            };

            const promptInput = {
                actions: playerActionsJson ? JSON.parse(playerActionsJson) : {},
                internalState: gameState.currentInternalStateMarkdown || "# Captain's Log - State Unknown",
                isRedAlertMode: gameState.mode === 'red_alert',
                clientGameState: clientStateContext // Add current client state for display reference
            };
            const promptInputString = JSON.stringify(promptInput, null, 2);
            const s = `${baseMainPrompt}${activeAddendum}\n\n--- Client Context: AI generates the ENTIRE HTML UI for #turn-content, including Status, Crew, Inventory displays (using values from 'clientGameState' as reference for the current state), Event, Images, and Choices. AI MUST return updated internalState Markdown in the hidden field. Client simply renders the full HTML response. Remember Pollinations.ai URL format. ---\n\n--- Input State ---\n${promptInputString}\n\n--- Generate Next Game Turn RAW HTML UI SNIPPET (for ENTIRE #turn-content) ---`;
            return s;
        }
    }

    // --- Modified Save/Load ---
    function saveGameState(isAutoSave = true) { // Default to auto-save
        if (!gameState.isLocked) {
            if (!isAutoSave) showClipboardMessage("Cannot save: Engage drive first!", true);
            return false;
        }
        if (!gameState.apiKey) {
            if (!isAutoSave) showClipboardMessage("Cannot save: Stardrive key missing!", true);
            return false;
        }
        try {
            // Ensure API key is encoded before saving full state
            gameState.encodedApiKey = encodeApiKey(gameState.apiKey);
            const stateJsonString = JSON.stringify(gameState);
            localStorage.setItem(LOCAL_STORAGE_KEY, stateJsonString);
            if (isAutoSave) {
                console.log("Captain's Log auto-saved (Full State). Turn:", gameState.turn);
            } else {
                console.log("Captain's Log manually saved (Full State). Turn:", gameState.turn);
                showClipboardMessage("Progress saved to browser storage!"); // Simple confirmation
            }
            return true;
        } catch (error) {
            console.error(`Save error (Full State):`, error);
            if (!isAutoSave) showClipboardMessage("Error saving progress! Blarg!", true);
            return false;
        }
    }

    // --- Audio ---
    function initAudioContext() {
        if (!audioCtx) { try { audioCtx = new (window.AudioContext || window.webkitAudioContext)(); console.log("AudioContext initialized."); if (audioCtx.state === 'suspended') audioCtx.resume(); } catch (e) { console.error("Web Audio API not supported.", e); } }
        if (audioCtx && audioCtx.state === 'suspended') { audioCtx.resume().catch(err => console.error("Error resuming audio context:", err)); }
    }
    function playTurnSound() {
        initAudioContext(); if (!audioCtx || audioCtx.state !== 'running') return; const now = audioCtx.currentTime; const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain(); osc.type = 'sawtooth'; osc.frequency.setValueAtTime(110, now); osc.frequency.exponentialRampToValueAtTime(880, now + 0.15); gain.gain.setValueAtTime(0.15, now); gain.gain.exponentialRampToValueAtTime(0.001, now + 0.5); osc.connect(gain); gain.connect(audioCtx.destination); osc.start(now); osc.stop(now + 0.5); console.log("Playing dubious sci-fi sound... 📟");
    }

    // --- Modified Response Processing ---
    function processSuccessfulResponse(responseHTML) {
        try {
            console.log("Received FULL HTML UI response from API.");

            // Simply replace the entire content
            turnContentContainer.innerHTML = responseHTML;
            console.log("Updated #turn-content with new FULL HTML UI.");

            // Still need to extract hidden state for the *next* request
            const form = turnContentContainer.querySelector('#space-opera-turn-form');
            if (form) {
                const turnInput = form.querySelector('input[name="turn"]');
                const subjectInput = form.querySelector('input[name="subjectId"]');
                const internalStateInput = form.querySelector('input[name="internalState"]');

                const nextTurn = turnInput ? parseInt(turnInput.value, 10) : gameState.turn + 1;
                gameState.currentSubjectId = subjectInput ? subjectInput.value : gameState.currentSubjectId;
                gameState.currentInternalStateMarkdown = internalStateInput ? internalStateInput.value : gameState.currentInternalStateMarkdown;

                console.log(`Extracted State for Next Turn: Turn=${nextTurn}, Subject=${gameState.currentSubjectId}, InternalState Length=${gameState.currentInternalStateMarkdown.length}`);

                // --- PARSE STATE CHANGES FROM LOG ---
                // The AI now calculates and *logs* state changes.
                // We need to parse the *new* internalState Markdown to update the *client's logical gameState*
                // This is crucial so the *next* prompt gets the correct numerical values/lists.
                try {
                    parseAndUpdateStateFromMarkdown(gameState.currentInternalStateMarkdown);
                    gameState.turn = nextTurn; // Update turn number *after* parsing state for that turn log
                } catch (parseError) {
                    console.error("Error parsing state updates from internalState Markdown:", parseError);
                    // Maybe attempt recovery or show warning? For now, log error.
                    // Turn number might get desynced if parsing fails consistently.
                    gameState.turn = nextTurn; // Update turn anyway? Risky. Let's update it.
                }
                // --- End State Parsing ---


                // Execute any inline scripts included in the response HTML
                const scripts = turnContentContainer.querySelectorAll('script');
                scripts.forEach(script => {
                    try {
                        const newScript = document.createElement("script");
                        for (let i = 0; i < script.attributes.length; i++) {
                            newScript.setAttribute(script.attributes[i].name, script.attributes[i].value);
                        }
                        newScript.appendChild(document.createTextNode(script.innerHTML));
                        turnContentContainer.appendChild(newScript);
                        console.log("Executed inline script.");
                        script.remove();
                    } catch (scriptError) {
                        console.error("Error executing inline script:", scriptError, script.innerHTML);
                    }
                });

            } else {
                console.warn("Could not find #space-opera-turn-form in the received HTML. State might be stale.");
                gameState.turn++; // Increment turn anyway, but state parsing won't happen
            }

            if (!gameState.isLocked) {
                gameState.isLocked = true;
                if (apiKeySection) apiKeySection.style.display = 'none';
                saveGameButton.disabled = false;
                resetGameButton.disabled = false;
                console.log("API Key locked. Stardrive is hot.");
                // REMOVED: persistentUiArea.style.display = 'grid';
            }

            // Update UI based on new gameState
            // REMOVED: renderAllPersistentUI();
            submitButton.textContent = `Submit Turn ${gameState.turn}`; // Use the potentially updated turn number
            submitButton.disabled = false;

            playTurnSound();
            saveGameState(true); // Auto-save

        } catch (renderError) {
            console.error("Failed to process HTML response:", renderError, responseHTML);
            showError("Dang! Received garbled subspace transmission. Cannot update the log. ;_;");
            setLoading(false);
        }
    }

    // --- NEW: Parse State Updates from Markdown ---
    function parseAndUpdateStateFromMarkdown(markdown) {
        if (!markdown || typeof markdown !== 'string') {
            console.warn("Invalid markdown provided for state parsing.");
            return;
        }
        console.log("Parsing internalState Markdown to update client gameState...");

        // Simple Regex approach (can be made more robust)
        const statusRegex = /\*\s*Current Status:\s*Fuel (\d+).*Morale (\d+).*Clankiness (\d+).*Heat (\d+).*SpiceCredits (\d+)/i;
        const crewRegex = /\*\s*Crew Roster:\s*(\[.*?\])/s; // Capture JSON-like array
        const inventoryRegex = /\*\s*Inventory:\s*(\[.*?\])/s; // Capture JSON-like array
        const profileRegex = /\*\s*Player Profile:\s*(\{.*?\})/s; // Capture JSON object

        const statusMatch = markdown.match(statusRegex);
        const crewMatch = markdown.match(crewRegex);
        const inventoryMatch = markdown.match(inventoryRegex);
        const profileMatch = markdown.match(profileRegex);

        let updated = false;

        if (statusMatch) {
            try {
                const fuel = parseInt(statusMatch[1], 10);
                const morale = parseInt(statusMatch[2], 10);
                const clankiness = parseInt(statusMatch[3], 10);
                const heat = parseInt(statusMatch[4], 10);
                const spiceCredits = parseInt(statusMatch[5], 10);

                // Basic validation: check if they are numbers
                if (![fuel, morale, clankiness, heat, spiceCredits].some(isNaN)) {
                    gameState.status = { fuel, morale, clankiness, heat, spiceCredits };
                    console.log("Parsed and updated gameState.status:", gameState.status);
                    updated = true;
                } else {
                    console.warn("Parsed status values were NaN, skipping update.");
                }
            } catch(e) { console.error("Error parsing status values:", e); }
        } else {
            console.warn("Could not find 'Current Status:' line in markdown log for parsing.");
            // Attempt fallback to individual lines if primary fails (more brittle)
            const parseLine = (label) => {
                const regex = new RegExp(`\\*\\s*${label}[^\\d]*(\\d+)`, 'i');
                const match = markdown.match(regex);
                return match ? parseInt(match[1], 10) : NaN;
            };
            const fuel = parseLine("Fuel");
            const morale = parseLine("Morale");
            const clankiness = parseLine("Clankiness");
            const heat = parseLine("Heat");
            const spiceCredits = parseLine("SpiceCredits");
            if (![fuel, morale, clankiness, heat, spiceCredits].some(isNaN)) {
                gameState.status = { fuel, morale, clankiness, heat, spiceCredits };
                console.log("Parsed and updated gameState.status (fallback):", gameState.status);
                updated = true;
            } else {
                console.warn("Fallback status parsing failed or yielded NaN.");
            }
        }

        // NOTE: Parsing Crew/Inventory/Profile relies on the AI consistently outputting
        // them in a JSON-parseable format within the Markdown log. This might be fragile.
        const parseJsonBlock = (match, stateKey) => {
            if (match && match[1]) {
                try {
                    // Attempt to clean up markdown/escaped chars if needed, then parse
                    const cleanedJsonString = match[1].replace(/\\`/g, '`').replace(/\\"/g, '"').replace(/\\\\/g, '\\');
                    const parsedData = JSON.parse(cleanedJsonString);
                    gameState[stateKey] = parsedData;
                    console.log(`Parsed and updated gameState.${stateKey}:`, gameState[stateKey]);
                    updated = true;
                } catch (e) {
                    console.error(`Error parsing JSON for ${stateKey} from markdown:`, e, "\nAttempted to parse:", match[1]);
                }
            } else {
                console.warn(`Could not find '${stateKey}' block in markdown log for parsing.`);
            }
        };

        parseJsonBlock(crewMatch, 'crew');
        parseJsonBlock(inventoryMatch, 'inventory');
        parseJsonBlock(profileMatch, 'profile'); // Keep profile updated if AI modifies/logs it


        if (!updated) {
            console.warn("Did not parse any state updates from the markdown log.");
        }
    }


    // --- Modified API Fetch ---
    async function fetchTurnData(playerActionsJson) {
        console.log("fetchTurnData called (Full UI Gen mode).");
        initAudioContext();
        if (!gameState.apiKey) {
            showError("Need a Stardrive Key to go anywhere! ✨");
            setLoading(false);
            if (apiKeySection && apiKeySection.style.display === 'none') apiKeySection.style.display = 'block';
            return;
        }

        setLoading(true);
        hideError();
        loadingMessage.textContent = getRandomLoadingMessage();

        let success = false;
        let attempts = 0;
        const maxAttempts = AVAILABLE_MODELS.length * 2 + 1;
        let consecutiveErrors = 0;

        while (!success && attempts < maxAttempts) {
            attempts++;
            const currentModel = AVAILABLE_MODELS[gameState.currentModelIndex];
            console.log(`Attempt ${attempts}/${maxAttempts}: Model ${currentModel}`);

            try {
                const prompt = constructPrompt(playerActionsJson);
                const response = await callRealGeminiAPI(gameState.apiKey, prompt, currentModel, "text/plain");
                processSuccessfulResponse(response); // Process the full HTML UI
                success = true;
                consecutiveErrors = 0;
            } catch (error) {
                console.error(`Error with ${currentModel} (Attempt ${attempts}):`, error);
                consecutiveErrors++;
                const isQuota = error.message.includes('429') || /quota|resource/i.test(error.message);
                const shouldSwitch = isQuota || consecutiveErrors >= 2;

                if (shouldSwitch && AVAILABLE_MODELS.length > 1) {
                    const oldModel = currentModel;
                    gameState.currentModelIndex = (gameState.currentModelIndex + 1) % AVAILABLE_MODELS.length;
                    const nextModel = AVAILABLE_MODELS[gameState.currentModelIndex];
                    console.warn(`Switching model due to errors/quota from ${oldModel} to ${nextModel}.`);
                    showError(`Subspace interference with ${oldModel}... Rerouting via ${nextModel}! (Attempt ${attempts + 1})`);
                    consecutiveErrors = 0;
                } else if (attempts < maxAttempts) {
                    showError(`Temporary glitch with ${currentModel}... Retrying! (Attempt ${attempts + 1})`);
                }

                if (!success && attempts < maxAttempts) {
                    await new Promise(resolve => setTimeout(resolve, 750));
                }
            }
        }

        if (!success) {
            console.error(`Failed after ${maxAttempts} attempts.`);
            showError(`Blast it! Failed to generate the next log entry after ${maxAttempts} tries! Check your key/connection.`);
            turnContentContainer.innerHTML = `<div class="space-card error-message">Could not load the next part of the voyage. Try resetting or reloading.</div>`;
        } else {
            hideError();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        setLoading(false);
    }

    // --- callRealGeminiAPI (unchanged, ensures BLOCK_NONE) ---
    async function callRealGeminiAPI(apiKey, promptText, modelName, responseMimeType = "text/plain") {
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${apiKey}`;
        const requestBody = {
            contents: [{ parts: [{ text: promptText }] }],
            generationConfig: {
                temperature: 1.0,
                response_mime_type: responseMimeType
            },
            safetySettings: [
                {"category": "HARM_CATEGORY_HARASSMENT", "threshold": "BLOCK_NONE"},
                {"category": "HARM_CATEGORY_HATE_SPEECH", "threshold": "BLOCK_NONE"},
                {"category": "HARM_CATEGORY_SEXUALLY_EXPLICIT", "threshold": "BLOCK_NONE"},
                {"category": "HARM_CATEGORY_DANGEROUS_CONTENT", "threshold": "BLOCK_NONE"}
            ]
        };

        console.log("Sending API request to:", API_URL);
        // console.log("Request Body Snippet:", JSON.stringify(requestBody).substring(0, 300));

        const response = await fetch(API_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(requestBody)
        });

        if (!response.ok) {
            let errorBodyText = `API Error (${response.status})`;
            try { const errorJson = await response.json(); errorBodyText += `: ${JSON.stringify(errorJson.error)}`; }
            catch (e) { try { errorBodyText += `: ${await response.text()}`; } catch (e2) {} }
            console.error("API Error Response Body:", errorBodyText);
            throw new Error(errorBodyText);
        }

        const data = await response.json();

        if (data.promptFeedback?.blockReason) {
            console.error("API Blocked Prompt. Reason:", data.promptFeedback.blockReason, "Ratings:", data.promptFeedback.safetyRatings);
            throw new Error(`Request blocked by API censorship. Reason: ${data.promptFeedback.blockReason}.`);
        }
        if (!data.candidates?.length) {
            if (typeof data === 'string') {
                console.warn("API Response OK but format was unexpected string:", data.substring(0, 100));
                return data.trim();
            }
            console.error("API Response OK but no candidates:", data);
            throw new Error('API returned successfully but generated no candidates. Check response format.');
        }

        const candidate = data.candidates[0];

        if (candidate.finishReason && !["STOP", "MAX_TOKENS"].includes(candidate.finishReason)) {
            const reason = `API Finish Reason: ${candidate.finishReason}. Safety Ratings: ${JSON.stringify(candidate.safetyRatings)}`;
            console.warn(reason + " (Content might be incomplete or filtered)");
            if (!candidate.content?.parts?.length) { throw new Error(reason + " (No content returned despite finish reason)"); }
        }
        if (!candidate.content?.parts?.length || !candidate.content.parts[0].text) {
            console.error("API candidate generated but no valid content part found:", candidate);
            throw new Error('API candidate generated but no valid text content found.');
        }

        const htmlContent = candidate.content.parts[0].text;
        const trimmedContent = htmlContent.trim();

        if (trimmedContent.startsWith('```') && trimmedContent.endsWith('```')) {
            const markdownMatch = trimmedContent.match(/^```(?:html)?\s*([\s\S]*?)\s*```$/);
            if (markdownMatch && markdownMatch[1]) {
                console.log("Extracted HTML from markdown block.");
                return markdownMatch[1].trim();
            } else {
                console.warn(`API response looked like markdown but failed extraction. Using raw content.`);
                return trimmedContent;
            }
        } else if (!trimmedContent.startsWith('<') || !trimmedContent.endsWith('>')) {
            console.warn(`API response might not be valid HTML. Snippet: ${trimmedContent.substring(0, 100)}...`);
        }
        return trimmedContent;
    }

    // --- Error Display ---
    function showError(message) { errorDisplay.textContent = message; errorDisplay.style.display = 'block'; }
    function hideError() { errorDisplay.textContent = ''; errorDisplay.style.display = 'none'; }

    // --- Input Collection (Largely Unchanged, updates local profile) ---
    function collectInputState() {
        const form = turnContentContainer.querySelector('#space-opera-turn-form');
        if (!form) {
            console.warn("Could not find #space-opera-turn-form to collect input.");
            return JSON.stringify({ turn: gameState.turn, subjectId: gameState.currentSubjectId });
        }

        const formData = new FormData(form);
        const inputs = {};
        const checkboxGroups = {};

        form.querySelectorAll('input[type="checkbox"]').forEach(cb => { if (!checkboxGroups[cb.name]) checkboxGroups[cb.name] = []; });

        for (const [key, value] of formData.entries()) {
            if (checkboxGroups.hasOwnProperty(key)) checkboxGroups[key].push(value);
            else inputs[key] = value;
        }
        for (const key in checkboxGroups) { if (checkboxGroups[key].length > 0) inputs[key] = checkboxGroups[key]; }

        console.log("Collected form data:", inputs);

        // Add turn/subject if missing, remove internalState
        if (!inputs.hasOwnProperty('turn')) inputs.turn = gameState.turn;
        if (!inputs.hasOwnProperty('subjectId')) inputs.subjectId = gameState.currentSubjectId;
        delete inputs.internalState;

        // Update client gameState profile if profiling fields are present (Turn 1 mainly)
        // The AI should also log this in its internalState
        if (inputs.profile_species) gameState.profile.species = inputs.profile_species;
        if (inputs.profile_role) gameState.profile.role = inputs.profile_role;
        if (inputs.profile_attraction) gameState.profile.orientation = Array.isArray(inputs.profile_attraction) ? inputs.profile_attraction : [inputs.profile_attraction];
        if (inputs.profile_preferences) gameState.profile.preferences = Array.isArray(inputs.profile_preferences) ? inputs.profile_preferences : [inputs.profile_preferences]; // Assuming checkboxes
        if (inputs.profile_motivation) gameState.profile.motivation = inputs.profile_motivation;

        return JSON.stringify(inputs);
    }

    // --- Utilities ---
    function showClipboardMessage(message, isError = false) { clipboardMessage.textContent = message; clipboardMessage.style.color = isError ? '#f43f5e' : '#22d3ee'; setTimeout(() => { clipboardMessage.textContent = ''; }, 3500); }
    function updateModeButtonVisuals() {
        if (gameState.mode === 'red_alert') {
            modeToggleButton.textContent = 'Mode: Red Alert Romance 🔥';
            modeToggleButton.classList.add('red-alert-mode');
            modeToggleButton.classList.remove('standard-mode');
        } else {
            modeToggleButton.textContent = 'Mode: Standard Operations 🛠️';
            modeToggleButton.classList.remove('red-alert-mode');
            modeToggleButton.classList.add('standard-mode');
        }
    }
    function setDynamicImages() {
        const seed = Math.floor(Math.random() * 65536);
        const p = "wide panoramic retro futuristic sci fi landscape bizarre alien planet raygun gothic atompunk style";
        if (headerBanner) {
            headerBanner.src = `https://image.pollinations.ai/prompt/${encodeURIComponent(p)}?width=1200&height=120&seed=${seed}&nologo=true&safe=false`;
            headerBanner.alt = "Retro Sci-Fi Space Banner";
        }
    }

    // --- Loading State (Unchanged) ---
    const LOADING_MESSAGES = [ /* ... */ ];
    function getRandomLoadingMessage() { /* ... */ }
    function setLoading(loading) {
        gameState.isLoading = loading;
        loadingIndicator.style.display = loading ? 'flex' : 'none';
        loadingMessage.textContent = loading ? getRandomLoadingMessage() : '';

        const keyEntered = gameState.apiKey && gameState.apiKey.length > 0;

        submitButton.disabled = loading || !(gameState.isLocked || keyEntered);
        saveGameButton.disabled = loading || !gameState.isLocked;
        modeToggleButton.disabled = loading;
        resetGameButton.disabled = loading || !(gameState.isLocked || keyEntered);
        apiKeyInput.disabled = loading || gameState.isLocked;

        const form = turnContentContainer.querySelector('#space-opera-turn-form');
        if (form) {
            form.style.opacity = loading ? 0.5 : 1.0;
            form.style.pointerEvents = loading ? 'none' : 'auto';
            form.querySelectorAll('input, textarea, button, select, fieldset').forEach(el => {
                if (el.id !== 'submit-turn-button') el.disabled = loading;
            });
        }
    }

    // --- Get Default Game State (Unchanged) ---
    function getDefaultGameState() {
        return JSON.parse(JSON.stringify({
            apiKey: null, encodedApiKey: null, turn: 0, mode: 'standard',
            profile: { species: "unspecified", role: "unspecified", orientation: "unspecified", preferences: [], motivation: "unspecified" },
            status: { fuel: 80, morale: 50, clankiness: 30, heat: 10, spiceCredits: 0 },
            crew: [], inventory: [], currentSubjectId: "Crewmate",
            currentInternalStateMarkdown: "", currentModelIndex: 0, isLoading: false, isLocked: false
        }));
    }


    // --- Modified Initialization ---
    function initializeGame() {
        console.log("Initializing Cosmic Climax Crusaders Deluxe Mk III (Full UI Gen Mode)...");
        let autoStarted = false;
        const storedStateString = localStorage.getItem(LOCAL_STORAGE_KEY);

        if (storedStateString) {
            console.log("Found saved Captain's Log (Full State).");
            let savedState;
            try {
                savedState = JSON.parse(storedStateString);
                const decodedApiKey = decodeApiKey(savedState.encodedApiKey);
                if (!decodedApiKey) throw new Error("Failed to decode API key from saved log.");

                gameState = { ...getDefaultGameState(), ...savedState };
                gameState.apiKey = decodedApiKey;
                gameState.isLoading = false;

                if (gameState.turn > 0 && gameState.isLocked && gameState.currentInternalStateMarkdown) {
                    autoStarted = true;
                    console.log(`Log restored. Mode: ${gameState.mode}, Turn: ${gameState.turn}`);

                    apiKeyInput.value = gameState.apiKey;
                    apiKeySection.style.display = 'none';
                    // REMOVED: persistentUiArea.style.display = 'grid';

                    updateModeButtonVisuals();
                    // REMOVED: renderAllPersistentUI(); // No longer needed
                    setDynamicImages();
                    hideError();

                    // Display "Game Loaded" message and let user submit to get the UI for the current turn
                    turnContentContainer.innerHTML = `<div class="space-card text-center text-lime-400">Captain's Log restored to Stardate ${gameState.turn}. Hit 'Submit Turn ${gameState.turn}' to generate the current view and continue your dubious journey.</div>`;
                    submitButton.textContent = `Submit Turn ${gameState.turn}`;
                    submitButton.disabled = false;
                    saveGameButton.disabled = false;
                    resetGameButton.disabled = false;
                    modeToggleButton.disabled = false;
                    setLoading(false);

                } else {
                    console.warn("Restored state seems incomplete or initial. Starting fresh.");
                    localStorage.removeItem(LOCAL_STORAGE_KEY);
                    gameState = getDefaultGameState();
                    autoStarted = false;
                    resetManualStartUI();
                }

            } catch (e) {
                console.error("Restore error (Full State):", e);
                showError(`Log restore error: ${e.message}. Please start manually!`);
                localStorage.removeItem(LOCAL_STORAGE_KEY);
                gameState = getDefaultGameState();
                autoStarted = false;
                apiKeyInput.value = '';
                resetManualStartUI();
            }
        }

        if (!autoStarted) {
            try {
                const params = new URLSearchParams(window.location.search);
                const keyFromUrl = params.get('apiKey');
                if (keyFromUrl) {
                    console.log("API Key found in URL.");
                    gameState = getDefaultGameState();
                    gameState.apiKey = keyFromUrl;
                    apiKeyInput.value = keyFromUrl;
                    gameState.isLocked = false;

                    apiKeySection.style.display = 'none';

                    const url = new URL(window.location.href);
                    url.searchParams.delete('apiKey');
                    window.history.replaceState(null, '', url.toString());

                    setDynamicImages();
                    updateModeButtonVisuals();
                    fetchTurnData(null); // Fetch Turn 1 UI
                    autoStarted = true;
                    setLoading(true);
                    submitButton.textContent = "Engaging...";
                }
            } catch (e) {
                console.error("URL Parameter processing error:", e);
                showError("Error reading URL parameters. Please start manually!");
                autoStarted = false;
            }
        }

        if (!autoStarted) {
            console.log("Manual start required.");
            gameState = getDefaultGameState();
            resetManualStartUI();
        }
    }

    // --- Modified Reset UI ---
    function resetManualStartUI() {
        turnContentContainer.innerHTML = ''; // Clear previous turn content
        // REMOVED: persistentUiArea.style.display = 'none';
        hideError();

        const initialMsgDiv = createInitialMessageDiv();
        initialMsgDiv.style.display = 'block';
        initialMsgDiv.innerHTML = 'Feed the API Key into the console and hit "Engage!"';
        turnContentContainer.appendChild(initialMsgDiv); // Add message to main content area

        if (apiKeySection) apiKeySection.style.display = 'block';
        apiKeyInput.value = gameState.apiKey || '';
        apiKeyInput.disabled = false;

        submitButton.textContent = 'Engage!';
        submitButton.disabled = !(gameState.apiKey && gameState.apiKey.length > 0);
        saveGameButton.disabled = true;
        resetGameButton.disabled = !(gameState.apiKey && gameState.apiKey.length > 0);
        modeToggleButton.disabled = false; // Allow mode toggle before start

        setLoading(false);
        updateModeButtonVisuals();
        setDynamicImages();
    }

    // Helper to get/create the initial message div (Unchanged)
    function createInitialMessageDiv() {
        let msgDiv = document.getElementById('initial-message');
        if (!msgDiv) {
            msgDiv = document.createElement('div');
            msgDiv.id = 'initial-message';
            msgDiv.className = 'text-center text-cyan-400 p-4 font-semibold space-card';
        } else {
            msgDiv.className = 'text-center text-cyan-400 p-4 font-semibold space-card';
        }
        return msgDiv;
    }

    // --- Event Listeners (Largely Unchanged) ---
    submitButton.addEventListener('click', () => {
        if (!submitButton.disabled && !gameState.isLoading) {
            console.log("Submit button clicked.");
            initAudioContext();
            const actions = collectInputState(); // Collects form data, updates local profile
            // FetchTurnData now relies on gameState having been updated (e.g., by collectInputState or parseAndUpdateStateFromMarkdown)
            fetchTurnData(actions);
        }
    });

    apiKeyInput.addEventListener('input', () => {
        const key = apiKeyInput.value.trim();
        gameState.apiKey = key;
        const keyEntered = key.length > 0;

        submitButton.disabled = gameState.isLoading || !(keyEntered || gameState.isLocked);
        resetGameButton.disabled = gameState.isLoading || !keyEntered;

        if (apiKeySection.style.display !== 'none') {
            const msg = document.getElementById('initial-message');
            if (msg && msg.style.display !== 'none') {
                if (keyEntered) {
                    hideError();
                    msg.textContent = 'Stardrive Key detected! Hit "Engage!"';
                } else {
                    msg.innerHTML = 'Feed the API Key into the console and hit "Engage!"';
                }
            }
        }
    });

    saveGameButton.addEventListener('click', () => {
        console.log("Manual Save clicked.");
        saveGameState(false);
    });

    modeToggleButton.addEventListener('click', () => {
        if (gameState.isLoading) return;
        gameState.mode = (gameState.mode === 'standard') ? 'red_alert' : 'standard';
        console.log(`Mode toggled to: ${gameState.mode}`);
        updateModeButtonVisuals();
        if (gameState.isLocked) {
            saveGameState(true); // Auto-save includes the mode change
        }
    });

    resetGameButton.addEventListener('click', () => {
        if (gameState.isLoading || resetGameButton.disabled) return;
        if (confirm('Abandon ship?! All log data will be jettisoned from browser storage! Are you sure?')) {
            console.log("Resetting game...");
            localStorage.removeItem(LOCAL_STORAGE_KEY);
            gameState = getDefaultGameState();
            resetManualStartUI();
        }
    });

    // --- Initialize ---
    initializeGame();

</script>

</body>
</html>